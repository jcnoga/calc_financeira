<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira para PMEs</title>
    
    <!-- BLOQUEIO DE EXECU√á√ÉO DIRETA (file://) -->
    <script>
        if (window.location.protocol === 'file:') {
            document.write('<div style="font-family:sans-serif; text-align:center; padding:50px;"><h1>‚ö†Ô∏è Execu√ß√£o Bloqueada</h1><p>Por seguran√ßa e funcionamento do Firebase, este aplicativo n√£o pode ser executado diretamente pelo arquivo (file://).</p><p>Utilize um servidor local (ex: Live Server do VSCode, XAMPP, Python http.server) ou hospede na web.</p></div>');
            throw new Error("Execu√ß√£o via file:// bloqueada.");
        }
    </script>

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- CSS Integrado -->
    <style>
        :root {
            --cor-primaria: #007bff;
            --cor-secundaria: #6c757d;
            --cor-sucesso: #28a745;
            --cor-perigo: #dc3545;
            --cor-fundo: #f8f9fa;
            --cor-fundo-card: #ffffff;
            --cor-texto: #343a40;
            --cor-texto-claro: #6c757d;
            --sombra: 0 4px 12px rgba(0, 0, 0, 0.05);
            --borda-raio: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            line-height: 1.6;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 1rem auto;
            background: var(--cor-fundo-card);
            border-radius: var(--borda-raio);
            box-shadow: var(--sombra);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex: 1; /* Para ocupar espa√ßo e empurrar o footer */
        }

        /* Header Atualizado */
        header {
            padding: 1.5rem 2rem;
            background-color: var(--cor-primaria);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-content {
            flex: 1;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .welcome-msg {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .license-info {
            font-size: 0.8rem;
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 5px;
        }

        /* Indicador de Status da Nuvem */
        .cloud-status {
            font-size: 0.8rem;
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-right: 10px;
        }

        .btn-logout, .btn-license {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }
        
        .btn-logout:hover, .btn-license:hover {
            background: rgba(255,255,255,0.3);
        }

        header h1 {
            margin-bottom: 0.25rem;
            font-size: 1.75rem;
        }

        header p {
            margin: 0;
            opacity: 0.9;
        }

        /* --- ESTILOS DE AUTENTICA√á√ÉO --- */
        .auth-container {
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            text-align: center;
        }

        .auth-form-card {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-title {
            color: var(--cor-primaria);
            margin-bottom: 1rem;
        }

        .auth-links {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .auth-links a {
            color: var(--cor-primaria);
            text-decoration: none;
            cursor: pointer;
            margin: 0 0.5rem;
        }

        .auth-links a:hover {
            text-decoration: underline;
        }

        .btn-google {
            background-color: #fff;
            color: #757575;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-google:hover {
            background-color: #f1f1f1;
            border-color: #ccc;
        }
        .google-icon {
            width: 18px;
            height: 18px;
        }
        .auth-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 10px 0;
            color: #aaa;
            font-size: 0.85rem;
        }
        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #eee;
        }
        .auth-divider span {
            padding: 0 10px;
        }

        /* Utilit√°rio para esconder se√ß√µes */
        .hidden {
            display: none !important;
        }

        /* Navega√ß√£o por Abas */
        .app-nav {
            display: flex;
            background-color: #f1f1f1;
            border-bottom: 1px solid #ddd;
        }

        .app-nav button {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--cor-secundaria);
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }

        .app-nav button:hover {
            background-color: #e9e9e9;
        }

        .app-nav button.active {
            color: var(--cor-primaria);
            border-bottom-color: var(--cor-primaria);
        }

        /* Conte√∫do das Abas */
        .app-content {
            padding: 2rem;
        }

        .app-section {
            display: none;
        }

        .app-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Formul√°rio de Entrada */
        #financial-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        details {
            border: 1px solid #ddd;
            border-radius: var(--borda-raio);
            overflow: hidden;
        }

        summary {
            padding: 1rem;
            background-color: #f9f9f9;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            list-style: none;
        }

        summary::-webkit-details-marker {
            display: none;
        }
        
        summary::before {
            content: '‚ñ∫ ';
            font-size: 0.8em;
            margin-right: 0.5rem;
        }

        details[open] summary::before {
            content: '‚ñº ';
        }

        .form-fields-grid {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .label-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--cor-texto-claro);
            margin-bottom: 0; 
        }

        .btn-help {
            background: transparent;
            border: 1px solid var(--cor-primaria);
            color: var(--cor-primaria);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0;
        }

        .btn-help:hover {
            background: var(--cor-primaria);
            color: white;
        }

        .form-group input {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: var(--borda-raio);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--cor-primaria);
            background-color: #f0f8ff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            transform: translateY(-2px);
        }

        .form-group input:not(:placeholder-shown) {
            border-left: 4px solid var(--cor-primaria);
        }

        .form-error {
            color: var(--cor-perigo);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .backup-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--borda-raio);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--cor-primaria);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #e9ecef;
            color: var(--cor-texto);
            border: 1px solid #ced4da;
        }

        .btn-secondary:hover {
            background-color: #dde0e3;
            border-color: #adb5bd;
        }

        /* Se√ß√£o de Resultados */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .results-header h2 {
            margin: 0;
        }

        .results-actions button {
            margin-left: 0.5rem;
            background: none;
            border: 1px solid var(--cor-secundaria);
            color: var(--cor-secundaria);
            padding: 0.5rem 1rem;
            border-radius: var(--borda-raio);
            cursor: pointer;
            font-weight: 600;
        }

        .results-actions button:hover {
            background-color: var(--cor-secundaria);
            color: white;
        }

        .results-category h3 {
            font-size: 1.5rem;
            color: var(--cor-primaria);
            border-bottom: 2px solid var(--cor-primaria);
            padding-bottom: 0.5rem;
            margin: 2rem 0 1.5rem 0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .indicator-card {
            background: var(--cor-fundo-card);
            border: 1px solid #e0e0e0;
            border-radius: var(--borda-raio);
            box-shadow: var(--sombra);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }

        .indicator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0,123,255,0.1);
        }
        
        .card-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--cor-primaria);
        }

        .card-header h4 {
            font-size: 1.1rem;
            margin: 0;
            color: var(--cor-texto);
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--cor-primaria);
            margin-bottom: 0.5rem;
        }
        
        .card-value.positive { color: var(--cor-sucesso); }
        .card-value.negative { color: var(--cor-perigo); }
        .card-value.neutral { color: var(--cor-primaria); }

        .card-description {
            font-size: 0.9rem;
            color: var(--cor-texto-claro);
            flex-grow: 1;
            margin-bottom: 1rem;
        }

        .card-action {
            text-align: right;
        }

        .btn-details {
            background: none;
            border: none;
            color: var(--cor-primaria);
            font-weight: 600;
            cursor: pointer;
            padding: 0.25rem;
        }

        /* Modal Comum e Modal de Bloqueio */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1; visibility: visible;
        }

        .modal-content {
            background: white; padding: 2rem; border-radius: var(--borda-raio);
            max-width: 600px; width: 90%; max-height: 90vh;
            overflow-y: auto; transform: scale(0.9); transition: all 0.3s ease;
        }
        
        .modal-overlay.active .modal-content { transform: scale(1); }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem;
        }
        
        .modal-header h3 { font-size: 1.5rem; color: var(--cor-primaria); }

        .modal-close {
            font-size: 2rem; font-weight: 300; border: none;
            background: none; cursor: pointer; line-height: 1;
        }
        
        .modal-section-title {
            font-size: 1.1rem; color: var(--cor-secundaria);
            margin-top: 1.5rem; margin-bottom: 0.5rem; display: block;
        }
        
        .modal-body .formula {
            background: #f1f1f1; padding: 0.75rem; border-radius: var(--borda-raio);
            font-family: 'Courier New', Courier, monospace; font-weight: 600; color: #333;
        }
        
        .modal-body p { font-size: 0.95rem; line-height: 1.7; }

        .modal-body .interpretation {
            border-left: 4px solid var(--cor-sucesso); padding-left: 1rem;
            font-style: italic; background: #f9fef9;
        }

        .modal-body .interpretation.negative { border-left-color: var(--cor-perigo); background: #fef9f9; }
        .modal-body .interpretation.neutral { border-left-color: var(--cor-primaria); background: #f9f9ff; }

        /* Estilo Espec√≠fico Modal Bloqueio/Licen√ßa */
        .lock-code-display {
            background: #333; color: #0f0; padding: 10px;
            font-family: monospace; font-size: 1.5rem; text-align: center;
            margin: 15px 0; border-radius: 4px;
        }
        
        footer {
            background-color: #343a40;
            color: #fff;
            text-align: center;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        footer a {
            color: #fff;
            text-decoration: none;
            font-weight: bold;
        }
        
        footer a:hover {
            text-decoration: underline;
            color: var(--cor-primaria);
        }
        
        /* Estilos do Rodap√© de Doa√ß√£o */
        .donation-area {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .donation-title {
            margin-bottom: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .btn-donate {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 5px 5px 5px;
            font-weight: bold;
            transition: 0.2s;
        }
        
        .btn-donate:hover {
            background-color: #e0a800;
            transform: scale(1.05);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .app-content { padding: 1rem; }
            .form-fields-grid { grid-template-columns: 1fr; }
            .results-header { flex-direction: column; align-items: flex-start; }
            .results-actions { width: 100%; display: flex; gap: 0.5rem; }
            .results-actions button { flex: 1; margin-left: 0; }
            .form-actions { flex-direction: column-reverse; }
            .form-actions button, .backup-controls { width: 100%; }
            .backup-controls { justify-content: space-between; }
            .backup-controls button { flex: 1; }
            header { flex-direction: column; text-align: center; gap: 1rem; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="header-content">
                <h1>Calculadora Financeira PME</h1>
                <p>Entenda a sa√∫de do seu neg√≥cio com 25 indicadores essenciais.</p>
            </div>
            <!-- Controles de Usu√°rio (Vis√≠vel apenas se logado) -->
            <div id="user-area" class="user-controls hidden">
                <div id="cloud-status" class="cloud-status">‚òÅÔ∏è Conectado</div>
                <span id="license-display" class="license-info">Licen√ßa: Verificando...</span>
                <button id="btn-add-credits" class="btn-license">üîë Cr√©ditos</button>
                <span id="user-welcome" class="welcome-msg">Ol√°, Usu√°rio</span>
                <button id="btn-logout" class="btn-logout">Sair</button>
            </div>
        </header>

        <!-- ======================= -->
        <!--   SISTEMA DE LOGIN      -->
        <!-- ======================= -->
        <div id="auth-section">
            
            <!-- Tela de Login -->
            <div id="login-view" class="auth-container">
                <h2 class="auth-title">Acesso Restrito</h2>
                <div class="auth-form-card">
                    <div class="form-group">
                        <label for="login-email">E-mail</label>
                        <input type="email" id="login-email" placeholder="seu@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="login-pass">Senha</label>
                        <input type="password" id="login-pass" placeholder="******" required>
                    </div>
                    <button id="btn-do-login" class="btn btn-primary" style="width: 100%;">Entrar</button>
                    
                    <!-- Op√ß√£o Google -->
                    <div class="auth-divider"><span>ou</span></div>
                    <button id="btn-google-login" class="btn btn-google">
                        <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                        Entrar com Google
                    </button>
                </div>
                <div class="auth-links">
                    <a id="link-to-register">Criar conta</a> | 
                    <a id="link-to-forgot">Esqueci minha senha</a>
                </div>
            </div>

            <!-- Tela de Cadastro -->
            <div id="register-view" class="auth-container hidden">
                <h2 class="auth-title">Criar Nova Conta</h2>
                <div class="auth-form-card">
                    <div class="form-group">
                        <label for="reg-name">Nome Completo</label>
                        <input type="text" id="reg-name" placeholder="Seu nome" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-email">E-mail</label>
                        <input type="email" id="reg-email" placeholder="seu@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="reg-pass">Senha</label>
                        <input type="password" id="reg-pass" placeholder="******" required>
                    </div>
                    <button id="btn-do-register" class="btn btn-primary" style="width: 100%;">Cadastrar</button>
                </div>
                <div class="auth-links">
                    <a id="link-to-login">J√° tenho conta. Fazer Login</a>
                </div>
            </div>

            <!-- Tela de Recupera√ß√£o -->
            <div id="forgot-view" class="auth-container hidden">
                <h2 class="auth-title">Recuperar Senha</h2>
                <p>Informe seu e-mail para receber as instru√ß√µes.</p>
                <div class="auth-form-card">
                    <div class="form-group">
                        <label for="forgot-email">E-mail Cadastrado</label>
                        <input type="email" id="forgot-email" placeholder="seu@email.com" required>
                    </div>
                    <button id="btn-do-forgot" class="btn btn-primary" style="width: 100%;">Enviar Recupera√ß√£o</button>
                </div>
                <div class="auth-links">
                    <a id="link-back-login">Voltar ao Login</a>
                </div>
            </div>
        </div>

        <!-- Container Principal da Aplica√ß√£o (Oculto at√© login) -->
        <div id="main-application" class="hidden">
            <nav class="app-nav">
                <button id="tab-btn-input" class="active" data-tab="input-section">1. Entrada de Dados</button>
                <button id="tab-btn-results" data-tab="results-section">2. Resultados e An√°lise</button>
            </nav>

            <main class="app-content">

                <!-- ======================= -->
                <!--   SE√á√ÉO DE ENTRADA      -->
                <!-- ======================= -->
                <section id="input-section" class="app-section active">
                    <form id="financial-form">
                        
                        <details open>
                            <summary>Dados Operacionais (DRE)</summary>
                            <div class="form-fields-grid">
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="faturamentoBruto">Faturamento Bruto (Mensal)</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Faturamento Bruto" 
                                            data-description="√â o valor total de todas as vendas realizadas (produtos ou servi√ßos) antes de descontar impostos, devolu√ß√µes ou custos. Basicamente, √© todo o dinheiro gerado pela opera√ß√£o de vendas da empresa no m√™s.">?</button>
                                    </div>
                                    <input type="number" id="faturamentoBruto" placeholder="R$ 100000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="custosVariaveis">Custos Vari√°veis Totais (CMV/CPV)</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Custos Vari√°veis" 
                                            data-description="S√£o os custos que aumentam ou diminuem diretamente com o volume de vendas. Exemplos: Custo da mercadoria vendida (CMV), mat√©ria-prima, embalagens, comiss√µes de vendedores e taxas de cart√£o de cr√©dito. Se voc√™ n√£o vender nada, esses custos deveriam ser zero.">?</button>
                                    </div>
                                    <input type="number" id="custosVariaveis" placeholder="R$ 40000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="custosFixos">Custos Fixos Totais (Mensal)</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Custos Fixos" 
                                            data-description="S√£o as despesas que voc√™ tem que pagar todo m√™s, independentemente de vender muito ou pouco. Exemplos: Aluguel, sal√°rios administrativos, internet, contabilidade, software, pr√≥-labore fixo.">?</button>
                                    </div>
                                    <input type="number" id="custosFixos" placeholder="R$ 25000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="numeroVendas">N√∫mero de Vendas (Mensal)</label>
                                        <button type="button" class="btn-help" 
                                            data-title="N√∫mero de Vendas" 
                                            data-description="A quantidade total de transa√ß√µes, pedidos ou contratos fechados no per√≠odo. Se um mesmo cliente comprou duas vezes, conte como duas vendas. Esse n√∫mero √© essencial para calcular o Ticket M√©dio.">?</button>
                                    </div>
                                    <input type="number" id="numeroVendas" placeholder="1000" step="1" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="impostos">Impostos e Juros (sobre Lucro)</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Impostos e Juros" 
                                            data-description="O valor total pago em impostos (como DAS, ICMS, ISS, IRPJ/CSLL) e despesas financeiras (juros de empr√©stimos) no m√™s. Aqui, focamos nos valores que saem ap√≥s o lucro operacional para chegar ao lucro l√≠quido.">?</button>
                                    </div>
                                    <input type="number" id="impostos" placeholder="R$ 5000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                            </div>
                        </details>
                        
                        <details>
                            <summary>Balan√ßo Patrimonial</summary>
                             <div class="form-fields-grid">
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="ativosTotais">Ativos Totais</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Ativos Totais" 
                                            data-description="A soma de tudo o que a empresa possui que tem valor econ√¥mico. Inclui dinheiro em caixa, estoque, maquin√°rio, m√≥veis, computadores, ve√≠culos, im√≥veis e contas a receber.">?</button>
                                    </div>
                                    <input type="number" id="ativosTotais" placeholder="R$ 150000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="patrimonioLiquido">Patrim√¥nio L√≠quido</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Patrim√¥nio L√≠quido" 
                                            data-description="√â a riqueza real dos donos na empresa. Matematicamente, √© Ativos (o que tem) menos Passivos (o que deve). Representa o capital social investido mais os lucros acumulados que foram reinvestidos.">?</button>
                                    </div>
                                    <input type="number" id="patrimonioLiquido" placeholder="R$ 80000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="ativosCirculantes">Ativos Circulantes</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Ativos Circulantes" 
                                            data-description="S√£o os bens e direitos que podem ser transformados em dinheiro no curto prazo (geralmente at√© 12 meses). Exemplos: Dinheiro em caixa, saldo no banco, estoques e contas a receber de clientes.">?</button>
                                    </div>
                                    <input type="number" id="ativosCirculantes" placeholder="R$ 50000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="passivosCirculantes">Passivos Circulantes</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Passivos Circulantes" 
                                            data-description="S√£o as d√≠vidas e obriga√ß√µes que a empresa precisa pagar no curto prazo (geralmente at√© 12 meses). Exemplos: Fornecedores a pagar, impostos a recolher, sal√°rios do m√™s e parcelas de empr√©stimos vencendo em breve.">?</button>
                                    </div>
                                    <input type="number" id="passivosCirculantes" placeholder="R$ 25000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                            </div>
                        </details>

                        <details>
                            <summary>Investimento</summary>
                             <div class="form-fields-grid">
                                <div class="form-group">
                                    <div class="label-wrapper">
                                        <label for="investimentoInicial">Investimento Inicial (Total)</label>
                                        <button type="button" class="btn-help" 
                                            data-title="Investimento Inicial" 
                                            data-description="O valor total que foi colocado na empresa para ela come√ßar a funcionar. Inclui reformas, compra de equipamentos, estoque inicial, capital de giro inicial e taxas de abertura. Usado para calcular o ROI.">?</button>
                                    </div>
                                    <input type="number" id="investimentoInicial" placeholder="R$ 200000" step="0.01" required>
                                    <span class="form-error">Valor obrigat√≥rio</span>
                                </div>
                            </div>
                        </details>
                        
                        <div class="form-actions">
                            <div class="backup-controls">
                                <!-- Bot√µes de Backup e Restore -->
                                <button type="button" id="btn-backup" class="btn btn-secondary">‚¨á Backup (JSON)</button>
                                <button type="button" id="btn-restore-trigger" class="btn btn-secondary">üìÇ Restaurar</button>
                                <!-- Bot√£o Demo -->
                                <button type="button" id="btn-demo-data" class="btn btn-secondary" style="opacity: 0.7; font-size: 0.9rem;" title="Preencher com dados de exemplo">üé≤ Exemplo</button>
                                <input type="file" id="file-restore" accept=".json" style="display: none;">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Calcular 25 Indicadores üöÄ</button>
                        </div>
                    </form>
                </section>

                <!-- ======================= -->
                <!--   SE√á√ÉO DE RESULTADOS   -->
                <!-- ======================= -->
                <section id="results-section" class="app-section">
                    <div class="results-header">
                        <h2>Seu Diagn√≥stico Financeiro</h2>
                        <div class="results-actions">
                            <button id="btn-recalculate">üîÑ Recalcular</button>
                            <button id="btn-export-csv">üíæ Exportar CSV</button>
                            <button id="btn-copy-clipboard">üìã Copiar Resumo</button>
                        </div>
                    </div>

                    <div id="results-wrapper">
                        <!-- Categorias e Cards ser√£o injetados aqui pelo JS -->
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- RODAP√â -->
    <footer>
        <p>¬© 2024 Calculadora Financeira PME. Todos os direitos reservados.</p>
        
        <div class="donation-area">
            <p class="donation-title">Apoie este projeto (Chave PIX copiada ao clicar):</p>
            <button class="btn-donate" data-val="7">R$ 7,00</button>
            <button class="btn-donate" data-val="13">R$ 13,00</button>
            <button class="btn-donate" data-val="17">R$ 17,00</button>
            <button class="btn-donate" data-val="0">Outro Valor</button>
        </div>

        <p><a href="http://www.websitelog.com.br" target="_blank">www.websitelog.com.br</a></p>
    </footer>

    <!-- ======================= -->
    <!--   MODAL DE DETALHES     -->
    <!-- ======================= -->
    <div id="modal-container" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Nome do Indicador</h3>
                <button id="modal-close" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <h4 class="modal-section-title" id="label-meaning">Significado</h4>
                <p id="modal-meaning">O que este indicador representa.</p>
                
                <h4 class="modal-section-title section-formula" id="label-formula">F√≥rmula</h4>
                <div id="modal-formula" class="formula section-formula">(F√≥rmula de c√°lculo)</div>

                <h4 class="modal-section-title section-interpretation" id="label-interpretation">Interpreta√ß√£o e Recomenda√ß√£o</h4>
                <p id="modal-interpretation" class="interpretation section-interpretation">Uma an√°lise pr√°tica do resultado.</p>
            </div>
        </div>
    </div>

    <!-- ======================= -->
    <!--   MODAL DE LICEN√áA      -->
    <!-- ======================= -->
    <div id="license-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h3>Gerenciar Cr√©ditos</h3>
                <button id="license-modal-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Seus cr√©ditos expiraram ou voc√™ deseja adicionar mais dias.</p>
                <div style="margin: 20px 0; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                    <p><strong>Passo 1:</strong> Gere o c√≥digo de solicita√ß√£o abaixo:</p>
                    <button id="btn-generate-code" class="btn btn-secondary">Gerar C√≥digo</button>
                    <div id="random-code-display" class="lock-code-display hidden"></div>
                </div>
                
                <div style="margin: 20px 0; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                    <p><strong>Passo 2:</strong> Insira a Contra-Senha (Formato: CODIGO-DIAS):</p>
                    <input type="text" id="unlock-code-input" placeholder="Ex: 2971-30" style="padding: 10px; width: 80%; font-size: 1.1rem; text-align: center;">
                    <button id="btn-validate-code" class="btn btn-primary" style="margin-top: 10px;">Liberar Acesso</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Integrado -->
    <script>
        // --- CONSTANTES DE SEGURAN√áA ---
        const CONST_ADD = 13;
        const CONST_MULT = 9;
        const CONST_BASE = 130954;

        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyDWwDLl34BLd1mYLSniJ8ucDTeaj4IX_2s",
          authDomain: "calc-financeira.firebaseapp.com",
          projectId: "calc-financeira",
          storageBucket: "calc-financeira.firebasestorage.app",
          messagingSenderId: "100771394956",
          appId: "1:100771394956:web:bc45a56637e96c829912a9",
          measurementId: "G-CM1DGS89CT"
        };

        // Inicializa Firebase (Se dispon√≠vel)
        let auth, googleProvider, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            googleProvider = new firebase.auth.GoogleAuthProvider();
        } catch (e) {
            console.error("Erro ao inicializar Firebase", e);
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- Gerenciamento de Autentica√ß√£o ---
            const authSection = document.getElementById('auth-section');
            const mainApp = document.getElementById('main-application');
            const userArea = document.getElementById('user-area');
            const userWelcome = document.getElementById('user-welcome');
            const btnLogout = document.getElementById('btn-logout');
            const cloudStatus = document.getElementById('cloud-status');
            const licenseDisplay = document.getElementById('license-display');
            const btnAddCredits = document.getElementById('btn-add-credits');
            const btnDonateItems = document.querySelectorAll('.btn-donate');

            // License Modal Elements
            const licenseModal = document.getElementById('license-modal');
            const licenseModalClose = document.getElementById('license-modal-close');
            const btnGenerateCode = document.getElementById('btn-generate-code');
            const randomCodeDisplay = document.getElementById('random-code-display');
            const unlockInput = document.getElementById('unlock-code-input');
            const btnValidateCode = document.getElementById('btn-validate-code');

            let currentRandomNumber = 0;

            // Elementos das Views de Auth
            const viewLogin = document.getElementById('login-view');
            const viewRegister = document.getElementById('register-view');
            const viewForgot = document.getElementById('forgot-view');

            // Links de Navega√ß√£o Auth
            document.getElementById('link-to-register').addEventListener('click', () => switchAuthView(viewRegister));
            document.getElementById('link-to-forgot').addEventListener('click', () => switchAuthView(viewForgot));
            document.getElementById('link-to-login').addEventListener('click', () => switchAuthView(viewLogin));
            document.getElementById('link-back-login').addEventListener('click', () => switchAuthView(viewLogin));

            // Bot√µes de A√ß√£o Auth
            document.getElementById('btn-do-login').addEventListener('click', handleLogin);
            document.getElementById('btn-do-register').addEventListener('click', handleRegister);
            document.getElementById('btn-do-forgot').addEventListener('click', handleForgotPass);
            document.getElementById('btn-google-login').addEventListener('click', handleGoogleLogin);
            
            btnLogout.addEventListener('click', handleLogout);
            btnAddCredits.addEventListener('click', openLicenseModal);
            
            // Bot√µes de Doa√ß√£o
            btnDonateItems.forEach(btn => {
                btn.addEventListener('click', handleDonation);
            });

            // License Modal Events
            licenseModalClose.addEventListener('click', () => licenseModal.classList.remove('active'));
            btnGenerateCode.addEventListener('click', generateChallenge);
            btnValidateCode.addEventListener('click', verifyUnlockCode);

            let currentUserEmail = null; 
            let currentUserData = null; // Armazena dados completos incluindo licen√ßa

            // Verificar sess√£o existente (Local)
            checkSession();

            // Listener de estado do Firebase
            if (auth) {
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        const appUser = {
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            pass: 'google-auth'
                        };
                        // Ao logar com Google, verifica se j√° tem dados para validar licen√ßa
                        // Se n√£o tiver (primeiro acesso), cria estrutura inicial
                        checkAndCreateUserStructure(appUser);
                    } else {
                        const loggedUser = sessionStorage.getItem('pme_logged_user');
                        if (!loggedUser) {
                            showAuth();
                        }
                    }
                });
            }

            function switchAuthView(viewToShow) {
                viewLogin.classList.add('hidden');
                viewRegister.classList.add('hidden');
                viewForgot.classList.add('hidden');
                viewToShow.classList.remove('hidden');
            }

            function checkSession() {
                const loggedUser = sessionStorage.getItem('pme_logged_user');
                if (loggedUser) {
                    const user = JSON.parse(loggedUser);
                    // Para usu√°rios locais, precisamos carregar os dados do localStorage para checar a licen√ßa
                    const usersDb = getUsersDb();
                    const fullUser = usersDb.find(u => u.email === user.email);
                    
                    if (fullUser) {
                        handleAppStart(fullUser);
                    } else {
                        // Fallback se algo estiver corrompido
                        handleAppStart(user); 
                    }
                }
            }

            // Fun√ß√£o Central para iniciar o app ap√≥s login (Local ou Firebase)
            function checkAndCreateUserStructure(user) {
                if (db) {
                    // Verifica se existe no Firestore
                    db.collection('user_data').doc(user.email).get().then((doc) => {
                        if (doc.exists) {
                            // Usu√°rio existe, usa dados da nuvem
                            handleAppStart({ ...user, ...doc.data() });
                        } else {
                            // Novo usu√°rio Firebase: Cria com 30 dias de licen√ßa
                            const newUser = {
                                ...user,
                                license: {
                                    validUntil: Date.now() + (30 * 24 * 60 * 60 * 1000)
                                }
                            };
                            db.collection('user_data').doc(user.email).set(newUser).then(() => {
                                handleAppStart(newUser);
                            });
                        }
                    }).catch(err => {
                        console.error("Erro ao verificar usu√°rio nuvem:", err);
                        handleAppStart(user); // Fallback offline
                    });
                } else {
                    handleAppStart(user);
                }
            }

            function handleAppStart(user) {
                currentUserEmail = user.email;
                currentUserData = user;

                // Verifica Licen√ßa
                checkLicenseValidity();

                authSection.classList.add('hidden');
                userArea.classList.remove('hidden');
                userWelcome.textContent = `Ol√°, ${user.name}`;
                
                // Carregar dados salvos do formul√°rio
                loadUserData(user.email);
            }

            function checkLicenseValidity() {
                const now = Date.now();
                let validUntil = 0;

                // Tenta pegar do objeto user atual (memoria)
                if (currentUserData && currentUserData.license && currentUserData.license.validUntil) {
                    validUntil = currentUserData.license.validUntil;
                } else {
                    // Se n√£o tiver estrutura de licen√ßa (usu√°rio legado ou erro), d√° 30 dias e salva
                    validUntil = now + (30 * 24 * 60 * 60 * 1000);
                    updateUserLicense(validUntil);
                }

                const daysLeft = Math.ceil((validUntil - now) / (1000 * 60 * 60 * 24));

                if (daysLeft > 0) {
                    licenseDisplay.textContent = `Licen√ßa: ${daysLeft} dias restantes`;
                    licenseDisplay.style.color = 'white';
                    mainApp.classList.remove('hidden');
                } else {
                    licenseDisplay.textContent = `Licen√ßa: EXPIRADA`;
                    licenseDisplay.style.color = '#ff9999';
                    mainApp.classList.add('hidden'); // Bloqueia acesso ao app
                    openLicenseModal(); // Abre modal de desbloqueio
                }
            }

            function openLicenseModal() {
                licenseModal.classList.add('active');
                randomCodeDisplay.classList.add('hidden');
                unlockInput.value = '';
            }

            function generateChallenge() {
                // Gera n√∫mero entre 100 e 1000
                currentRandomNumber = Math.floor(Math.random() * 901) + 100;
                randomCodeDisplay.textContent = currentRandomNumber;
                randomCodeDisplay.classList.remove('hidden');
            }

            function verifyUnlockCode() {
                const input = unlockInput.value.trim();
                // Formato esperado: CALCULO-DIAS
                const parts = input.split('-');
                
                if (parts.length !== 2) {
                    alert("Formato inv√°lido. Use: C√ìDIGO-DIAS (Ex: 132000-30)");
                    return;
                }

                const codeInput = parseInt(parts[0]);
                const daysInput = parseInt(parts[1]);

                // Valida√ß√£o: (Random + 13) * 9 + 130954
                const expectedCode = (currentRandomNumber + CONST_ADD) * CONST_MULT + CONST_BASE;

                if (codeInput === expectedCode) {
                    // Sucesso
                    const now = Date.now();
                    const newValidUntil = now + (daysInput * 24 * 60 * 60 * 1000);
                    
                    updateUserLicense(newValidUntil);
                    
                    alert(`Sucesso! Licen√ßa renovada por ${daysInput} dias.`);
                    licenseModal.classList.remove('active');
                    checkLicenseValidity(); // Atualiza UI
                } else {
                    alert("C√≥digo de desbloqueio inv√°lido.");
                }
            }

            function updateUserLicense(newTimestamp) {
                if (!currentUserData) return;

                // Atualiza objeto em mem√≥ria
                if (!currentUserData.license) currentUserData.license = {};
                currentUserData.license.validUntil = newTimestamp;

                // Atualiza LocalStorage (se usu√°rio local)
                const users = getUsersDb();
                const userIndex = users.findIndex(u => u.email === currentUserEmail);
                if (userIndex >= 0) {
                    users[userIndex].license = { validUntil: newTimestamp };
                    saveUserDb(users);
                }

                // Atualiza Firestore (se conectado)
                if (db) {
                    db.collection('user_data').doc(currentUserEmail).set({
                        license: { validUntil: newTimestamp }
                    }, { merge: true }).catch(err => console.error("Erro ao salvar licen√ßa nuvem", err));
                }
            }

            function handleDonation(event) {
                const amount = event.target.getAttribute('data-val');
                const pixKey = "b4648948-d0a8-4402-81f4-8a4047fcf4e5";
                let message = "";
                
                if (amount === "0") {
                    message = `Obrigado por apoiar! A chave PIX foi copiada. Voc√™ pode doar o valor que desejar.\n\nChave: ${pixKey}`;
                } else {
                    message = `Obrigado por apoiar com R$ ${amount},00! A chave PIX foi copiada.\n\nChave: ${pixKey}`;
                }
                
                // Cria um input tempor√°rio para copiar
                const tempInput = document.createElement("input");
                tempInput.value = pixKey;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);

                alert(message);
            }

            function showAuth() {
                currentUserEmail = null;
                currentUserData = null;
                authSection.classList.remove('hidden');
                mainApp.classList.add('hidden');
                userArea.classList.add('hidden');
                switchAuthView(viewLogin);
            }

            function getUsersDb() {
                const users = localStorage.getItem('pme_calculator_users');
                return users ? JSON.parse(users) : [];
            }

            function saveUserDb(users) {
                localStorage.setItem('pme_calculator_users', JSON.stringify(users));
            }

            function handleRegister() {
                const name = document.getElementById('reg-name').value.trim();
                const email = document.getElementById('reg-email').value.trim();
                const pass = document.getElementById('reg-pass').value.trim();

                if (!name || !email || !pass) {
                    alert("Por favor, preencha todos os campos.");
                    return;
                }

                const users = getUsersDb();
                if (users.find(u => u.email === email)) {
                    alert("E-mail j√° cadastrado.");
                    return;
                }

                // Novo usu√°rio local ganha 30 dias
                const newUser = { 
                    name, 
                    email, 
                    pass,
                    license: {
                        validUntil: Date.now() + (30 * 24 * 60 * 60 * 1000)
                    }
                };

                users.push(newUser);
                saveUserDb(users);
                alert("Conta criada com sucesso! Voc√™ ganhou 30 dias de acesso.");
                
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-pass').value = '';
                
                switchAuthView(viewLogin);
            }

            function handleLogin() {
                const email = document.getElementById('login-email').value.trim();
                const pass = document.getElementById('login-pass').value.trim();

                if (!email || !pass) {
                    alert("Preencha e-mail e senha.");
                    return;
                }

                const users = getUsersDb();
                const user = users.find(u => u.email === email && u.pass === pass);

                if (user) {
                    sessionStorage.setItem('pme_logged_user', JSON.stringify(user));
                    handleAppStart(user);
                    document.getElementById('login-email').value = '';
                    document.getElementById('login-pass').value = '';
                } else {
                    alert("E-mail ou senha incorretos.");
                }
            }

            function handleGoogleLogin() {
                if (!auth) {
                    alert("Erro de configura√ß√£o do Firebase.");
                    return;
                }
                auth.signInWithPopup(googleProvider)
                    .then((result) => {
                        console.log("Logado com Google:", result.user);
                        // L√≥gica tratada no onAuthStateChanged
                    }).catch((error) => {
                        console.error(error);
                        alert("Erro ao entrar com Google: " + error.message);
                    });
            }

            function handleForgotPass() {
                const email = document.getElementById('forgot-email').value.trim();
                if (!email) {
                    alert("Informe seu e-mail.");
                    return;
                }
                if (auth) {
                    auth.sendPasswordResetEmail(email)
                        .then(() => {
                             alert(`E-mail de recupera√ß√£o enviado para ${email} (via Firebase).`);
                             switchAuthView(viewLogin);
                        })
                        .catch((error) => {
                            alert(`Se o e-mail ${email} estiver cadastrado, voc√™ receber√° um link de recupera√ß√£o em instantes.`);
                            switchAuthView(viewLogin);
                        });
                } else {
                    alert(`Se o e-mail ${email} estiver cadastrado, voc√™ receber√° um link de recupera√ß√£o em instantes.`);
                    switchAuthView(viewLogin);
                }
            }

            function handleLogout() {
                sessionStorage.removeItem('pme_logged_user');
                if (auth) {
                    auth.signOut().then(() => {
                        showAuth();
                    });
                } else {
                    showAuth();
                }
            }

            // --- SISTEMA DE SALVAMENTO ---
            function saveUserData(email) {
                if (!email) return;
                
                const inputs = getFormInputs();
                const dataToSave = JSON.stringify(inputs);
                
                localStorage.setItem(`pme_autosave_${email}`, dataToSave);
                updateCloudStatus("Salvando...", "orange");

                if (db) {
                    // Salva dados do form mas preserva licen√ßa existente
                    db.collection('user_data').doc(email).set(inputs, { merge: true })
                    .then(() => {
                        updateCloudStatus("‚òÅÔ∏è Salvo na Nuvem", "#28a745");
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar na nuvem:", error);
                        updateCloudStatus("üíæ Salvo Local (Offline)", "#6c757d");
                    });
                } else {
                    updateCloudStatus("üíæ Salvo Local", "#6c757d");
                }
            }

            function loadUserData(email) {
                if (!email) return;
                updateCloudStatus("Carregando...", "orange");

                if (db) {
                    db.collection('user_data').doc(email).get().then((doc) => {
                        if (doc.exists) {
                            populateForm(doc.data());
                            updateCloudStatus("‚òÅÔ∏è Sincronizado", "#28a745");
                        } else {
                            loadLocalData(email);
                        }
                    }).catch((error) => {
                        console.error("Erro ao carregar da nuvem:", error);
                        loadLocalData(email);
                    });
                } else {
                    loadLocalData(email);
                }
            }

            function loadLocalData(email) {
                const localData = localStorage.getItem(`pme_autosave_${email}`);
                if (localData) {
                    try {
                        const inputs = JSON.parse(localData);
                        populateForm(inputs);
                        updateCloudStatus("üíæ Carregado Local", "#6c757d");
                    } catch (e) {
                        console.error("Erro ao ler backup local", e);
                    }
                } else {
                    updateCloudStatus("Pronto", "#28a745");
                }
            }

            function populateForm(data) {
                // Filtra apenas campos do formul√°rio, ignora licen√ßa
                for (const [key, value] of Object.entries(data)) {
                    if (key === 'license') continue;
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = value;
                    }
                }
            }

            function updateCloudStatus(text, color) {
                if (cloudStatus) {
                    cloudStatus.textContent = text;
                    cloudStatus.style.borderLeft = `3px solid ${color}`;
                }
            }

            let saveTimeout;
            const formInputs = form.querySelectorAll('input');
            formInputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        saveUserData(currentUserEmail);
                    }, 1000);
                });
            });


            // --- Seletores do DOM da Aplica√ß√£o ---
            const tabButtons = document.querySelectorAll('.app-nav button');
            const tabSections = document.querySelectorAll('.app-section');
            const resultsWrapper = document.getElementById('results-wrapper');
            
            // Modal Elements
            const modalContainer = document.getElementById('modal-container');
            const modalCloseBtn = document.getElementById('modal-close');
            const modalTitle = document.getElementById('modal-title');
            const modalMeaning = document.getElementById('modal-meaning');
            const modalFormula = document.getElementById('modal-formula');
            const modalInterpretation = document.getElementById('modal-interpretation');
            const formulaSections = document.querySelectorAll('.section-formula');
            const interpretationSections = document.querySelectorAll('.section-interpretation');

            const recalculateBtn = document.getElementById('btn-recalculate');
            const exportCsvBtn = document.getElementById('btn-export-csv');
            const copyClipboardBtn = document.getElementById('btn-copy-clipboard');
            const helpButtons = document.querySelectorAll('.btn-help');

            // Backup Elements
            const btnBackup = document.getElementById('btn-backup');
            const btnRestoreTrigger = document.getElementById('btn-restore-trigger');
            const fileRestoreInput = document.getElementById('file-restore');
            const btnDemoData = document.getElementById('btn-demo-data');

            let calculatedResults = []; 
            
            // --- Defini√ß√µes dos √çcones e Indicadores ---
            const icons = {
                vendas: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
                custos: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>`,
                lucratividade: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
                equilibrio: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
                retorno: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`,
                atividade: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>`,
                liquidez: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 16.2A10 10 0 1 1 8 2.8c.1-.4.2-.8.4-1.1"></path><path d="M10 2.3c.2-.3.4-.7.7-1"></path><path d="M12 21a10 10 0 0 1-10-10c0-.5.1-1 .2-1.5"></path><path d="M7 19.8c.1.1.2.2.3.3"></path><path d="M2.8 16.2a10 10 0 0 1-.2-1.5"></path><path d="M2.3 14c-.1.3-.2.7-.2 1"></path><path d="M19.8 17c.1-.1.2-.2.3-.3"></path><path d="M14 2.3c.3.1.7.2 1 .2"></path><path d="M17 2.8c.1-.1.2-.2.3-.3"></path><path d="M16.2 2.8a10 10 0 0 1 1.5.2"></path><path d="M19 7c.1.1.2.2.3.3"></path><path d="M21.7 10a10 10 0 0 1 .2 1.5"></path><path d="M21.7 14c.1-.3.2-.7.2-1"></path><path d="M17.7 19.7c-.1.1-.2.2-.3.3"></path><path d="M11 16.8c-.1.4-.2.8-.4 1.1"></path><path d="M14 21.7c-.3.1-.7.2-1 .2"></path><path d="M8 21.7c-.1-.1-.2-.2-.3-.3"></path><path d="M4.2 17.7c.1-.1.2-.2.3-.3"></path><path d="M4.2 6.3c-.1.1-.2.2-.3.3"></path><path d="M6.3 4.2a10 10 0 0 1 1.5-.2"></path><path d="M8 2.3c-.1.1-.2.2-.3.3"></path><path d="M3.3 8a10 10 0 0 1-.2-1.5"></path><path d="M3.3 12c-.1.3-.2.7-.2 1"></path></details></svg>`,
                endividamento: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>`,
            };
            
            const indicatorDefinitions = [
                // Vendas
                {
                    id: 'faturamentoBruto',
                    name: 'Faturamento Bruto',
                    category: 'Vendas e Receita',
                    icon: icons.vendas,
                    calculate: (i) => i.faturamentoBruto,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Total de vendas de produtos ou servi√ßos antes de dedu√ß√µes.',
                    formula: 'Input Direto',
                    meaning: 'Este √© o volume total de receita gerado pela sua opera√ß√£o principal em um per√≠odo.',
                    interpretation: (v) => `Seu faturamento de R$ ${v.toFixed(2)} √© a linha de partida para todas as an√°lises. O objetivo √© sempre aument√°-lo ou torn√°-lo mais eficiente.`
                },
                {
                    id: 'ticketMedio',
                    name: 'Ticket M√©dio',
                    category: 'Vendas e Receita',
                    icon: icons.vendas,
                    calculate: (i) => i.faturamentoBruto / i.numeroVendas,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Valor m√©dio de cada venda realizada.',
                    formula: 'Faturamento Bruto / N¬∫ de Vendas',
                    meaning: 'Indica quanto, em m√©dia, cada cliente gasta por compra.',
                    interpretation: (v) => `Um ticket m√©dio de R$ ${v.toFixed(2)} sugere o perfil de compra do seu cliente. Para aumentar, considere estrat√©gias de upsell (vender um produto melhor) ou cross-sell (vender produtos complementares).`
                },
                
                // Custos
                {
                    id: 'custosVariaveis',
                    name: 'Custos Vari√°veis (Totais)',
                    category: 'Custos e Despesas',
                    icon: icons.custos,
                    calculate: (i) => i.custosVariaveis,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Custos que mudam conforme o volume de produ√ß√£o ou vendas (CMV/CPV).',
                    formula: 'Input Direto',
                    meaning: 'Representa o custo direto para produzir ou adquirir o que voc√™ vendeu.',
                    interpretation: (v) => `Seus custos vari√°veis de R$ ${v.toFixed(2)} s√£o o primeiro grande "obst√°culo" da sua receita. Negociar com fornecedores ou otimizar a produ√ß√£o pode reduzi-los.`
                },
                {
                    id: 'custosFixos',
                    name: 'Custos Fixos (Totais)',
                    category: 'Custos e Despesas',
                    icon: icons.custos,
                    calculate: (i) => i.custosFixos,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Custos que n√£o mudam com o volume de vendas (aluguel, sal√°rios, etc).',
                    formula: 'Input Direto',
                    meaning: '√â o custo para manter a empresa funcionando, independentemente de vender ou n√£o.',
                    interpretation: (v) => `Com custos fixos de R$ ${v.toFixed(2)}, voc√™ precisa gerar receita suficiente para cobri-los todos os meses. Mantenha-os sob controle rigoroso.`
                },
                {
                    id: 'custosTotais',
                    name: 'Custos Totais',
                    category: 'Custos e Despesas',
                    icon: icons.custos,
                    calculate: (i) => i.custosFixos + i.custosVariaveis,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Soma de todos os custos, fixos e vari√°veis.',
                    formula: 'Custos Fixos + Custos Vari√°veis',
                    meaning: 'O valor total que sua empresa gastou no per√≠odo para operar e vender.',
                    interpretation: (v) => `Seu custo operacional total √© de R$ ${v.toFixed(2)}. A efici√™ncia da sua gest√£o √© medida pela capacidade de reduzir este n√∫mero sem afetar a qualidade ou o faturamento.`
                },
                {
                    id: 'custoPorVenda',
                    name: 'Custo por Venda (CPV)',
                    category: 'Custos e Despesas',
                    icon: icons.custos,
                    calculate: (i) => (i.custosFixos + i.custosVariaveis) / i.numeroVendas,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Custo total m√©dio para realizar cada venda.',
                    formula: 'Custos Totais / N¬∫ de Vendas',
                    meaning: 'Mostra quanto custa, em m√©dia, cada transa√ß√£o realizada (n√£o confundir com Custo por Aquisi√ß√£o - CAC).',
                    interpretation: (v) => `Cada venda custa em m√©dia R$ ${v.toFixed(2)} para ser realizada. Compare este valor com seu Ticket M√©dio. Se o Custo por Venda for maior que o Ticket M√©dio, voc√™ tem um problema s√©rio.`
                },

                // Lucratividade e Margens
                {
                    id: 'margemContribuicaoVal',
                    name: 'Margem de Contribui√ß√£o (R$)',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => i.faturamentoBruto - i.custosVariaveis,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Valor que sobra do faturamento ap√≥s pagar os custos vari√°veis.',
                    formula: 'Faturamento Bruto - Custos Vari√°veis',
                    meaning: '√â o "motor" da empresa. Esse valor √© o que sobra para pagar os Custos Fixos e, depois, gerar Lucro.',
                    interpretation: (v, i) => `Voc√™ gerou R$ ${v.toFixed(2)} de Margem de Contribui√ß√£o. Este valor √© suficiente para pagar seus Custos Fixos de R$ ${i.custosFixos.toFixed(2)}? Se sim, a diferen√ßa √© seu Lucro Operacional.`
                },
                {
                    id: 'margemContribuicaoPerc',
                    name: 'Margem de Contribui√ß√£o (%)',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => ((i.faturamentoBruto - i.custosVariaveis) / i.faturamentoBruto) * 100,
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'Percentual do faturamento que vira margem de contribui√ß√£o.',
                    formula: '(Margem de Contribui√ß√£o R$ / Faturamento Bruto) * 100',
                    meaning: 'Indica a efici√™ncia da sua venda. Quanto maior, melhor.',
                    interpretation: (v) => `Sua margem √© de ${v.toFixed(2)}%. Isso significa que a cada R$ 100 vendidos, sobram R$ ${v.toFixed(2)} para pagar custos fixos e gerar lucro. Tente aumentar essa margem.`
                },
                {
                    id: 'lucroBruto',
                    name: 'Lucro Bruto',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => i.faturamentoBruto - i.custosVariaveis,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Resultado da empresa ap√≥s subtrair os custos diretos (vari√°veis).',
                    formula: 'Faturamento Bruto - Custos Vari√°veis',
                    meaning: 'Similar √† Margem de Contribui√ß√£o, mede a rentabilidade direta das suas vendas.',
                    interpretation: (v) => `Seu Lucro Bruto de R$ ${v.toFixed(2)} mostra o quanto sua atividade principal de venda √© rent√°vel antes de considerar a estrutura administrativa (custos fixos).`
                },
                {
                    id: 'margemBruta',
                    name: 'Margem Bruta (%)',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => ((i.faturamentoBruto - i.custosVariaveis) / i.faturamentoBruto) * 100,
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'Percentual do faturamento que sobra como Lucro Bruto.',
                    formula: '(Lucro Bruto / Faturamento Bruto) * 100',
                    meaning: 'Mede a rentabilidade dos seus produtos ou servi√ßos.',
                    interpretation: (v) => `Uma Margem Bruta de ${v.toFixed(2)}% √© um indicador chave. Se estiver baixa, seus custos vari√°veis (CMV/CPV) est√£o muito altos ou seu pre√ßo de venda est√° muito baixo.`
                },
                {
                    id: 'lucroOperacional',
                    name: 'Lucro Operacional (EBIT)',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => i.faturamentoBruto - i.custosVariaveis - i.custosFixos,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Lucro antes de impostos e juros. O resultado da opera√ß√£o.',
                    formula: 'Lucro Bruto - Custos Fixos',
                    meaning: 'Este √© o verdadeiro resultado da sua opera√ß√£o. Mostra se a empresa √© lucrativa em sua atividade principal.',
                    interpretation: (v) => v > 0 ? `Parab√©ns! Sua opera√ß√£o gerou R$ ${v.toFixed(2)} de lucro. Este valor mostra que sua empresa √© saud√°vel operacionalmente.` : `Aten√ß√£o! Sua opera√ß√£o deu um preju√≠zo de R$ ${v.toFixed(2)}. Voc√™ precisa vender mais, aumentar sua margem ou cortar custos fixos urgentemente.`
                },
                {
                    id: 'margemOperacional',
                    name: 'Margem Operacional (%)',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => ((i.faturamentoBruto - i.custosVariaveis - i.custosFixos) / i.faturamentoBruto) * 100,
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'Percentual do faturamento que vira Lucro Operacional.',
                    formula: '(Lucro Operacional / Faturamento Bruto) * 100',
                    meaning: 'Mede a efici√™ncia operacional da empresa como um todo.',
                    interpretation: (v) => `Sua Margem Operacional √© de ${v.toFixed(2)}%. A cada R$ 100 vendidos, sobram R$ ${v.toFixed(2)} como lucro da opera√ß√£o. ${v > 0 ? 'Este √© um bom sinal de efici√™ncia.' : 'Este √© um sinal de alerta. Sua estrutura de custos (fixos + vari√°veis) est√° muito pesada para seu faturamento.'}`
                },
                {
                    id: 'lucroLiquido',
                    name: 'Lucro L√≠quido',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => i.faturamentoBruto - i.custosVariaveis - i.custosFixos - i.impostos,
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'O valor final que "sobra" para o dono ou para reinvestimento.',
                    formula: 'Lucro Operacional - Impostos e Juros',
                    meaning: '√â o resultado final da empresa ap√≥s pagar absolutamente tudo. √â o que vai para o bolso.',
                    interpretation: (v) => v > 0 ? `Excelente! O Lucro L√≠quido do per√≠odo foi de R$ ${v.toFixed(2)}. Este √© o valor que pode ser distribu√≠do aos s√≥cios ou reinvestido na empresa.` : `Cuidado! A empresa teve um preju√≠zo l√≠quido de R$ ${v.toFixed(2)}. A opera√ß√£o n√£o est√° se pagando e est√° consumindo caixa ou aumentando d√≠vidas.`
                },
                {
                    id: 'margemLiquida',
                    name: 'Margem L√≠quida (Lucratividade)',
                    category: 'Lucratividade e Margens',
                    icon: icons.lucratividade,
                    calculate: (i) => ((i.faturamentoBruto - i.custosVariaveis - i.custosFixos - i.impostos) / i.faturamentoBruto) * 100,
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'O percentual de faturamento que vira lucro l√≠quido.',
                    formula: '(Lucro L√≠quido / Faturamento Bruto) * 100',
                    meaning: 'Este √© o indicador final de lucratividade. Mostra o qu√£o eficiente a empresa √© em transformar vendas em lucro.',
                    interpretation: (v) => `Sua Margem L√≠quida √© ${v.toFixed(2)}%. A cada R$ 100 faturados, R$ ${v.toFixed(2)} viram lucro de fato. ${v > 5 ? 'Uma √≥tima margem!' : 'Uma margem apertada. Analise seus custos ou estrat√©gia de pre√ßos.'}`
                },
                
                // Ponto de Equil√≠brio e Efici√™ncia
                {
                    id: 'pontoEquilibrioValor',
                    name: 'Ponto de Equil√≠brio (Valor)',
                    category: 'Efici√™ncia e Equil√≠brio',
                    icon: icons.equilibrio,
                    calculate: (i) => i.custosFixos / ((i.faturamentoBruto - i.custosVariaveis) / i.faturamentoBruto),
                    format: (v) => `R$ ${v.toFixed(2)}`,
                    description: 'Quanto voc√™ precisa faturar para cobrir todos os custos (lucro zero).',
                    formula: 'Custos Fixos / (Margem de Contribui√ß√£o %)',
                    meaning: '√â o faturamento m√≠nimo para a empresa "empatar" no m√™s, sem lucro nem preju√≠zo.',
                    interpretation: (v, i) => `Voc√™ precisa faturar R$ ${v.toFixed(2)} por m√™s apenas para pagar as contas. ${i.faturamentoBruto > v ? 'Voc√™ est√° acima do ponto de equil√≠brio, o que √© √≥timo!' : 'Aten√ß√£o! Voc√™ est√° faturando abaixo do seu ponto de equil√≠brio, operando no preju√≠zo.'}`
                },
                {
                    id: 'pontoEquilibrioUnidades',
                    name: 'Ponto de Equil√≠brio (Unidades)',
                    category: 'Efici√™ncia e Equil√≠brio',
                    icon: icons.equilibrio,
                    calculate: (i) => {
                        const margemPorUnidade = (i.faturamentoBruto - i.custosVariaveis) / i.numeroVendas;
                        return i.custosFixos / margemPorUnidade;
                    },
                    format: (v) => `${Math.ceil(v)} unidades`,
                    description: 'Quantas vendas voc√™ precisa fazer para atingir o lucro zero.',
                    formula: 'Custos Fixos / (Margem de Contribui√ß√£o por Unidade)',
                    meaning: 'Define a meta de vendas m√≠nima para a empresa n√£o ter preju√≠zo.',
                    interpretation: (v, i) => `Voc√™ precisa fazer ${Math.ceil(v)} vendas no m√™s para empatar. ${i.numeroVendas > v ? 'Voc√™ est√° vendendo mais que o m√≠nimo, gerando lucro.' : 'Voc√™ est√° vendendo menos que o necess√°rio para cobrir os custos.'}`
                },
                {
                    id: 'markup',
                    name: 'Markup (Divisor)',
                    category: 'Efici√™ncia e Equil√≠brio',
                    icon: icons.equilibrio,
                    calculate: (i) => i.faturamentoBruto / i.custosVariaveis,
                    format: (v) => `${v.toFixed(2)}x`,
                    description: 'M√∫ltiplo do seu custo vari√°vel que forma seu pre√ßo de venda.',
                    formula: 'Faturamento Bruto / Custos Vari√°veis',
                    meaning: 'Indica quantas vezes o seu pre√ßo de venda √© maior que o seu custo de aquisi√ß√£o/produ√ß√£o.',
                    interpretation: (v) => `Seu markup m√©dio √© ${v.toFixed(2)}x. Isso significa que, em m√©dia, voc√™ vende seus produtos por ${v.toFixed(2)} vezes o custo vari√°vel deles. (Ex: Custo R$ 10, Venda R$ 25 = Markup 2.5x).`
                },

                // Retorno (ROI, ROA, ROE)
                {
                    id: 'roi',
                    name: 'ROI (Retorno sobre Investimento)',
                    category: 'Retorno (Investimento e Ativos)',
                    icon: icons.retorno,
                    calculate: (i) => ((i.faturamentoBruto - i.custosVariaveis - i.custosFixos - i.impostos) * 12) / i.investimentoInicial * 100, // Lucro Anualizado
                    format: (v) => `${v.toFixed(2)}% a.a.`,
                    description: 'Percentual de retorno que o investimento inicial gerou (anualizado).',
                    formula: '(Lucro L√≠quido Anual / Investimento Inicial) * 100',
                    meaning: 'Mede a capacidade do neg√≥cio de gerar retorno sobre o dinheiro total investido para cri√°-lo.',
                    interpretation: (v) => `Seu ROI anualizado √© de ${v.toFixed(2)}%. ${v > 0 ? 'Isso √© o quanto o dinheiro investido no neg√≥cio rendeu. Compare com outras aplica√ß√µes (ex: Tesouro Selic) para ver se o risco est√° valendo a pena.' : 'Seu ROI est√° negativo, indicando que o investimento est√° gerando preju√≠zo.'}`
                },
                {
                    id: 'roa',
                    name: 'ROA (Retorno sobre Ativos)',
                    category: 'Retorno (Investimento e Ativos)',
                    icon: icons.retorno,
                    calculate: (i) => ((i.faturamentoBruto - i.custosVariaveis - i.custosFixos - i.impostos) / i.ativosTotais) * 100,
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'Efici√™ncia da empresa em gerar lucro a partir de seus ativos.',
                    formula: '(Lucro L√≠quido / Ativos Totais) * 100',
                    meaning: 'Mede o qu√£o eficientemente a empresa usa o que possui (m√°quinas, caixa, estoque) para gerar lucro.',
                    interpretation: (v) => `Seu ROA √© ${v.toFixed(2)}%. A cada R$ 100 em ativos, sua empresa gera R$ ${v.toFixed(2)} de lucro l√≠quido. ${v > 0 ? 'Quanto maior, mais eficiente √© sua gest√£o de ativos.' : 'Sua empresa n√£o est√° conseguindo rentabilizar seus ativos.'}`
                },
                {
                    id: 'roe',
                    name: 'ROE (Retorno sobre Patr. L√≠quido)',
                    category: 'Retorno (Investimento e Ativos)',
                    icon: icons.retorno,
                    calculate: (i) => ((i.faturamentoBruto - i.custosVariaveis - i.custosFixos - i.impostos) / i.patrimonioLiquido) * 100,
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'Retorno gerado sobre o capital pr√≥prio (dos s√≥cios).',
                    formula: '(Lucro L√≠quido / Patrim√¥nio L√≠quido) * 100',
                    meaning: 'Este √© o indicador que mais importa para o s√≥cio/investidor. Mede o quanto o capital pr√≥prio est√° rendendo.',
                    interpretation: (v) => `O retorno sobre o capital dos s√≥cios √© de ${v.toFixed(2)}%. ${v > 15 ? 'Este √© um retorno excelente sobre o capital investido.' : (v > 0 ? 'Este √© um retorno positivo.' : 'O capital dos s√≥cios est√° sendo destru√≠do com o preju√≠zo.')}`
                },
                
                // Atividade
                {
                    id: 'giroAtivo',
                    name: 'Giro do Ativo',
                    category: 'Atividade e Giro',
                    icon: icons.atividade,
                    calculate: (i) => i.faturamentoBruto / i.ativosTotais,
                    format: (v) => `${v.toFixed(2)}`,
                    description: 'Quantas vezes os ativos "giraram" para gerar receita.',
                    formula: 'Faturamento Bruto / Ativos Totais',
                    meaning: 'Mede a efici√™ncia com que a empresa usa seus ativos para gerar vendas. (N√£o √© lucro, √© vendas).',
                    interpretation: (v) => `Seu ativo girou ${v.toFixed(2)} vezes. Isso significa que para cada R$ 1,00 em ativos, voc√™ gerou R$ ${v.toFixed(2)} em vendas. ${v > 1 ? 'Isso indica boa efici√™ncia, especialmente no varejo.' : 'Isso indica baixa efici√™ncia ou que a empresa √© muito capital-intensiva (ind√∫stria pesada).'}`
                },
                
                // Liquidez e Endividamento
                {
                    id: 'liquidezCorrente',
                    name: '√çndice de Liquidez Corrente',
                    category: 'Liquidez e Endividamento',
                    icon: icons.liquidez,
                    calculate: (i) => i.ativosCirculantes / i.passivosCirculantes,
                    format: (v) => `${v.toFixed(2)}`,
                    description: 'Capacidade de pagar d√≠vidas de curto prazo.',
                    formula: 'Ativos Circulantes / Passivos Circulantes',
                    meaning: 'Mostra quanto a empresa tem a receber no curto prazo (caixa, estoque, clientes) para cada R$ 1,00 que deve pagar no curto prazo (fornecedores, impostos).',
                    interpretation: (v) => `Seu √≠ndice √© ${v.toFixed(2)}. ${v > 1.5 ? `√ìtimo. Voc√™ tem R$ ${v.toFixed(2)} para cada R$ 1,00 de d√≠vida de curto prazo, indicando folga.` : (v > 1 ? `Positivo. Voc√™ tem R$ ${v.toFixed(2)} para cada R$ 1,00 de d√≠vida, mas sem muita folga.` : `Alerta! Voc√™ tem menos de R$ 1,00 para pagar cada R$ 1,00 de d√≠vida de curto prazo. Risco de caixa.`)}`
                },
                {
                    id: 'endividamentoGeral',
                    name: 'Endividamento Geral',
                    category: 'Liquidez e Endividamento',
                    icon: icons.endividamento,
                    calculate: (i) => ((i.ativosTotais - i.patrimonioLiquido) / i.ativosTotais) * 100, // Passivo Total = Ativo Total - PL
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'Percentual dos ativos financiado por capital de terceiros.',
                    formula: '(Passivos Totais / Ativos Totais) * 100',
                    meaning: 'Mostra o qu√£o "alavancada" a empresa est√°. Quanto do que ela possui, ela deve a terceiros?',
                    interpretation: (v) => `Sua empresa √© ${v.toFixed(2)}% financiada por d√≠vidas. ${v > 50 ? 'Cuidado. Mais da metade dos seus ativos √© financiada por terceiros. Isso aumenta o risco.' : 'N√≠vel de endividamento controlado. Menos da metade dos seus ativos √© financiada por terceiros.'}`
                },
                {
                    id: 'grauEndividamento',
                    name: 'Grau de Endividamento (D√≠vida/PL)',
                    category: 'Liquidez e Endividamento',
                    icon: icons.endividamento,
                    calculate: (i) => (i.ativosTotais - i.patrimonioLiquido) / i.patrimonioLiquido,
                    format: (v) => `${v.toFixed(2)}`,
                    description: 'Quanto a empresa deve para cada R$ 1,00 de capital pr√≥prio.',
                    formula: 'Passivos Totais / Patrim√¥nio L√≠quido',
                    meaning: 'Mede a propor√ß√£o entre capital de terceiros (d√≠vida) e capital pr√≥prio (s√≥cios).',
                    interpretation: (v) => `Para cada R$ 1,00 dos s√≥cios, a empresa deve R$ ${v.toFixed(2)} a terceiros. ${v > 1 ? 'Risco alto. A empresa deve mais a terceiros do que aos pr√≥prios donos.' : 'Risco controlado. A empresa tem mais capital pr√≥prio do que d√≠vidas.'}`
                },
                {
                    id: 'impostosPerc',
                    name: 'Carga Tribut√°ria Efetiva (%)',
                    category: 'Lucratividade e Margens',
                    icon: icons.custos,
                    calculate: (i) => (i.impostos / (i.faturamentoBruto - i.custosVariaveis - i.custosFixos)) * 100,
                    format: (v) => `${v.toFixed(2)}%`,
                    description: 'Percentual do lucro operacional consumido por impostos e juros.',
                    formula: '(Impostos e Juros / Lucro Operacional) * 100',
                    meaning: 'Mede o impacto real dos impostos sobre o resultado da sua opera√ß√£o.',
                    interpretation: (v) => `Dos lucros operacionais gerados, ${v.toFixed(2)}% foram usados para pagar impostos e juros. √â fundamental revisar seu regime tribut√°rio (Simples, Presumido, Real) para otimizar essa carga.`
                },
            ];

            // --- Fun√ß√µes de Navega√ß√£o ---
            function switchTab(tabId) {
                tabSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === tabId) {
                        section.classList.add('active');
                    }
                });

                tabButtons.forEach(button => {
                    button.classList.remove('active');
                    if (button.dataset.tab === tabId) {
                        button.classList.add('active');
                    }
                });
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });

            recalculateBtn.addEventListener('click', () => {
                switchTab('input-section');
            });

            // --- Fun√ß√µes de Valida√ß√£o ---
            function validateForm() {
                let isValid = true;
                const inputs = form.querySelectorAll('input[required]');
                
                inputs.forEach(input => {
                    const errorEl = input.nextElementSibling;
                    if (input.value.trim() === '' || parseFloat(input.value) < 0) {
                        isValid = false;
                        input.style.borderColor = 'var(--cor-perigo)';
                        if (errorEl && errorEl.classList.contains('form-error')) {
                            errorEl.style.display = 'block';
                        }
                    } else {
                        input.style.borderColor = '#ccc';
                        if (errorEl && errorEl.classList.contains('form-error')) {
                            errorEl.style.display = 'none';
                        }
                    }
                });
                return isValid;
            }

            // --- Fun√ß√µes de Backup e Restore ---
            function backupData() {
                // Permite backup mesmo com dados parciais, mas avisa se inv√°lido
                if (!validateForm()) {
                    if (!confirm("Alguns campos est√£o vazios ou inv√°lidos. Deseja fazer o backup mesmo assim?")) {
                        return;
                    }
                }
                
                const inputs = getFormInputs();
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inputs, null, 2));
                const downloadAnchorNode = document.createElement('a');
                
                // Adiciona timestamp ao nome do arquivo
                const date = new Date().toISOString().slice(0, 10);
                const time = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `backup_financeiro_${date}_${time}.json`;
                
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", filename);
                document.body.appendChild(downloadAnchorNode); // Necess√°rio para Firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            function triggerRestore() {
                fileRestoreInput.value = null; // Reseta para permitir carregar o mesmo arquivo duas vezes
                fileRestoreInput.click();
            }

            fileRestoreInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Popula os campos
                        populateForm(data);
                        validateForm(); // Remove erros visuais se houver
                        
                        // Salva imediatamente para evitar perda se fechar
                        if (currentUserEmail) {
                            saveUserData(currentUserEmail);
                        }
                        
                        alert("Dados restaurados com sucesso! Clique em 'Calcular' para ver os resultados.");
                        
                    } catch (err) {
                        console.error(err);
                        alert("Erro ao ler o arquivo de backup. Certifique-se de que √© um arquivo JSON v√°lido.");
                    }
                };
                reader.readAsText(file);
            });

            // Event Listeners para Backup
            btnBackup.addEventListener('click', backupData);
            btnRestoreTrigger.addEventListener('click', triggerRestore);

            // --- Fun√ß√£o Demo Data (80k Faturamento PME) ---
            btnDemoData.addEventListener('click', () => {
                if(confirm('Deseja preencher o formul√°rio com dados de exemplo (PME Faturamento ~R$ 80k)? Isso substituir√° os dados atuais.')) {
                    // Valores ajustados para 80k de faturamento e Balan√ßo Patrimonial Equilibrado
                    // Ativos Totais (150k) = Passivos (50k) + PL (100k)
                    const demoValues = {
                        'faturamentoBruto': 80000,
                        'custosVariaveis': 32000, // ~40% do faturamento
                        'custosFixos': 24000,     // ~30% do faturamento
                        'numeroVendas': 800,      // Ticket M√©dio R$ 100
                        'impostos': 4800,         // ~6% (Simples Nacional Com√©rcio/Servi√ßo)
                        'ativosTotais': 150000,
                        'patrimonioLiquido': 100000,
                        'ativosCirculantes': 60000,
                        'passivosCirculantes': 50000,
                        'investimentoInicial': 100000
                    };

                    populateForm(demoValues);
                    
                    // Remove alertas visuais de erro se houver
                    validateForm();
                    
                    // Salva imediatamente para evitar perda se a aba for fechada
                    if (currentUserEmail) {
                        saveUserData(currentUserEmail);
                    }
                }
            });


            // --- Fun√ß√µes de C√°lculo e Exibi√ß√£o ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateForm()) {
                    const inputs = getFormInputs();
                    calculatedResults = calculateAllIndicators(inputs);
                    displayResults(calculatedResults);
                    switchTab('results-section');
                    saveUserData(currentUserEmail); // Salva explicitamente ao calcular
                } else {
                    alert('Por favor, preencha todos os campos obrigat√≥rios com valores v√°lidos (positivos).');
                }
            });

            function getFormInputs() {
                const fields = ['faturamentoBruto', 'custosVariaveis', 'custosFixos', 'numeroVendas', 'impostos', 'ativosTotais', 'patrimonioLiquido', 'ativosCirculantes', 'passivosCirculantes', 'investimentoInicial'];
                const inputs = {};
                fields.forEach(id => {
                    const val = parseFloat(document.getElementById(id).value);
                    inputs[id] = isNaN(val) ? 0 : val;
                });
                return inputs;
            }

            function calculateAllIndicators(inputs) {
                const results = [];
                const safeInputs = { ...inputs };
                
                // Garante que n√£o haja divis√£o por zero
                if (safeInputs.numeroVendas === 0) safeInputs.numeroVendas = 1;
                if (safeInputs.faturamentoBruto === 0) safeInputs.faturamentoBruto = 1;
                if (safeInputs.ativosTotais === 0) safeInputs.ativosTotais = 1;
                if (safeInputs.patrimonioLiquido === 0) safeInputs.patrimonioLiquido = 1;
                if (safeInputs.passivosCirculantes === 0) safeInputs.passivosCirculantes = 1;
                if (safeInputs.investimentoInicial === 0) safeInputs.investimentoInicial = 1;

                indicatorDefinitions.forEach(def => {
                    let rawValue;
                    try {
                        rawValue = def.calculate(inputs);
                    } catch (error) {
                        console.error(`Erro ao calcular ${def.name}: ${error}`);
                        rawValue = 0; 
                    }

                    if (isNaN(rawValue) || !isFinite(rawValue)) {
                        rawValue = 0;
                    }
                    
                    const formattedValue = def.format(rawValue);
                    const interpretation = def.interpretation(rawValue, inputs);
                    const sentiment = getSentiment(def.id, rawValue);
                    
                    results.push({
                        ...def,
                        rawValue,
                        formattedValue,
                        interpretation,
                        sentiment
                    });
                });
                return results;
            }
            
            function getSentiment(id, value) {
                if ([
                    'faturamentoBruto', 'ticketMedio', 'margemContribuicaoVal', 'margemContribuicaoPerc',
                    'lucroBruto', 'margemBruta', 'lucroOperacional', 'margemOperacional',
                    'lucroLiquido', 'margemLiquida', 'roi', 'roa', 'roe', 'giroAtivo'
                ].includes(id)) {
                    return value > 0 ? 'positive' : 'negative';
                }
                if (id === 'liquidezCorrente') {
                    return value > 1.2 ? 'positive' : (value > 0.8 ? 'neutral' : 'negative');
                }
                if ([
                    'custosVariaveis', 'custosFixos', 'custosTotais', 'custoPorVenda',
                    'endividamentoGeral', 'grauEndividamento', 'impostosPerc'
                ].includes(id)) {
                    return value > 0 ? 'negative' : 'neutral'; // Custos s√£o "negativos" por natureza
                }
                if (id === 'pontoEquilibrioValor' || id === 'pontoEquilibrioUnidades') {
                    return 'neutral';
                }
                return 'neutral';
            }

            function displayResults(results) {
                resultsWrapper.innerHTML = '';
                
                // Agrupa por categoria
                const categories = results.reduce((acc, result) => {
                    (acc[result.category] = acc[result.category] || []).push(result);
                    return acc;
                }, {});

                const categoryOrder = [
                    'Vendas e Receita',
                    'Custos e Despesas',
                    'Lucratividade e Margens',
                    'Efici√™ncia e Equil√≠brio',
                    'Retorno (Investimento e Ativos)',
                    'Atividade e Giro',
                    'Liquidez e Endividamento'
                ];
                
                for(const categoryName of categoryOrder) {
                    const items = categories[categoryName];
                    if (!items) continue;

                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'results-category';
                    categoryEl.innerHTML = `<h3>${categoryName}</h3>`;
                    
                    const gridEl = document.createElement('div');
                    gridEl.className = 'results-grid';

                    items.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'indicator-card';
                        card.innerHTML = `
                            <div class="card-header">
                                <div class="card-icon">${item.icon}</div>
                                <h4>${item.name}</h4>
                            </div>
                            <div class="card-value ${item.sentiment}">${item.formattedValue}</div>
                            <div class="card-description">${item.description}</div>
                            <div class="card-action">
                                <button class="btn-details" data-id="${item.id}">Ver An√°lise</button>
                            </div>
                        `;
                        
                        card.querySelector('.btn-details').addEventListener('click', () => {
                            openModal(item, true); // true = show all details
                        });
                        
                        gridEl.appendChild(card);
                    });
                    
                    categoryEl.appendChild(gridEl);
                    resultsWrapper.appendChild(categoryEl);
                }
            }

            // --- Fun√ß√µes do Modal ---
            function openModal(data, showFullDetails = false) {
                modalTitle.textContent = data.name || data.dataset.title;
                modalMeaning.textContent = data.meaning || data.dataset.description;
                
                if (showFullDetails) {
                    // Veio do Card de Resultado
                    modalFormula.textContent = data.formula;
                    modalInterpretation.textContent = data.interpretation;
                    modalInterpretation.className = `interpretation ${data.sentiment} section-interpretation`;
                    
                    formulaSections.forEach(el => el.classList.remove('hidden'));
                    interpretationSections.forEach(el => el.classList.remove('hidden'));
                } else {
                    // Veio do bot√£o de ajuda do Input
                    formulaSections.forEach(el => el.classList.add('hidden'));
                    interpretationSections.forEach(el => el.classList.add('hidden'));
                }

                modalContainer.classList.add('active');
            }

            function closeModal() {
                modalContainer.classList.remove('active');
            }

            modalCloseBtn.addEventListener('click', closeModal);
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) {
                    closeModal();
                }
            });

            helpButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(btn, false); 
                });
            });

            // --- Fun√ß√µes de Exporta√ß√£o ---
            function exportToCSV() {
                if (calculatedResults.length === 0) {
                    alert('Calcule os indicadores primeiro.');
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8," + encodeURI("Indicador,Valor Formatado,Categoria,Descricao\r\n");

                calculatedResults.forEach(item => {
                    const row = [
                        `"${item.name}"`,
                        `"${item.formattedValue.replace('R$ ', '')}"`, 
                        `"${item.category}"`,
                        `"${item.description.replace(/"/g, '""')}"` 
                    ].join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "diagnostico_financeiro.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function copyToClipboard() {
                if (calculatedResults.length === 0) {
                    alert('Calcule os indicadores primeiro.');
                    return;
                }
                
                let text = "Resumo do Diagn√≥stico Financeiro\r\n";
                text += "===================================\r\n\r\n";

                const categories = calculatedResults.reduce((acc, result) => {
                    (acc[result.category] = acc[result.category] || []).push(result);
                    return acc;
                }, {});

                for (const categoryName in categories) {
                    text += `--- ${categoryName.toUpperCase()} ---\r\n`;
                    categories[categoryName].forEach(item => {
                        text += `${item.name}: ${item.formattedValue}\r\n`;
                    });
                    text += "\r\n";
                }
                
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        alert('Resumo copiado para a √°rea de transfer√™ncia!');
                    } else {
                        alert('N√£o foi poss√≠vel copiar. Tente manualmente.');
                    }
                } catch (err) {
                    alert('Erro ao copiar. Tente manualmente.');
                }
                
                document.body.removeChild(textArea);
            }
            
            exportCsvBtn.addEventListener('click', exportToCSV);
            copyClipboardBtn.addEventListener('click', copyToClipboard);

        });
    </script>
</body>
</html>
```
